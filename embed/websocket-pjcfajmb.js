import{$ as Z,aa as U}from"./runtime-7ws0tb7k.js";import"./runtime-sm05dxvs.js";function A(F){if(!F||typeof F!=="object"||Array.isArray(F))return null;let q=F;if(typeof q.type!=="string")return null;let D={type:q.type};if(typeof q.componentId==="string")D.componentId=q.componentId;if(typeof q.action==="string")D.action=q.action;if(typeof q.key==="string")D.key=q.key;if(q.value!==void 0)D.value=q.value;if(typeof q.success==="boolean")D.success=q.success;if(q.data&&typeof q.data==="object"&&!Array.isArray(q.data))D.data=q.data;if(q.payload&&typeof q.payload==="object"&&!Array.isArray(q.payload))D.payload=q.payload;if(q.state&&typeof q.state==="object"&&!Array.isArray(q.state))D.state=q.state;if(q.diff&&typeof q.diff==="object"&&!Array.isArray(q.diff))D.diff=q.diff;if(q.patch&&typeof q.patch==="object"&&!Array.isArray(q.patch))D.patch=q.patch;if(typeof q.compressed==="boolean")D.compressed=q.compressed;if(typeof q.error==="string")D.error=q.error;if(typeof q.timestamp==="number")D.timestamp=q.timestamp;if(typeof q.sessionToken==="string")D.sessionToken=q.sessionToken;if(typeof q.clientId==="string")D.clientId=q.clientId;return D}var $="gospa_session";function B(){try{let F=sessionStorage.getItem($);if(F)return JSON.parse(F)}catch(F){console.warn("[GoSPA] Failed to load session:",F)}return null}function M(F){try{sessionStorage.setItem($,JSON.stringify(F))}catch(q){console.warn("[GoSPA] Failed to save session:",q)}}class z{ws=null;config;reconnectAttempts=0;heartbeatTimer=null;messageQueue=[];connectionState;pendingRequests=new Map;requestId=0;sessionData=null;constructor(F){this.config={reconnect:!0,reconnectInterval:1000,maxReconnectAttempts:10,heartbeatInterval:30000,onOpen:()=>{},onClose:()=>{},onError:()=>{},onConnectionFailed:()=>{},onMessage:()=>{},...F},this.connectionState=new U("disconnected"),this.sessionData=B();try{let q=sessionStorage.getItem("gospa_ws_queue");if(q)this.messageQueue=JSON.parse(q)||[],sessionStorage.removeItem("gospa_ws_queue")}catch(q){console.warn("[GoSPA] Failed to restore message queue:",q)}window.addEventListener("beforeunload",()=>{if(this.messageQueue.length>0)try{sessionStorage.setItem("gospa_ws_queue",JSON.stringify(this.messageQueue))}catch(q){console.warn("[GoSPA] Failed to persist message queue:",q)}})}get state(){return this.connectionState.get()}get isConnected(){return this.connectionState.get()==="connected"}connect(){return new Promise((F,q)=>{if(this.ws?.readyState===WebSocket.OPEN){F();return}this.connectionState.set("connecting");try{this.ws=new WebSocket(this.config.url)}catch(D){this.connectionState.set("disconnected"),q(D);return}this.ws.onopen=()=>{if(this.connectionState.set("connected"),this.reconnectAttempts=0,this.startHeartbeat(),this.sessionData?.token)this.send({type:"init",sessionToken:this.sessionData.token,clientId:this.sessionData.clientId});this.flushMessageQueue(),this.send({type:"sync"}),this.config.onOpen(),F()},this.ws.onclose=(D)=>{if(this.connectionState.set("disconnected"),this.stopHeartbeat(),this.config.onClose(D),this.config.reconnect&&this.reconnectAttempts<this.config.maxReconnectAttempts)this.scheduleReconnect();else this.config.onConnectionFailed(Error("Max reconnect attempts reached"))},this.ws.onerror=(D)=>{if(this.config.onError(D),this.connectionState.get()==="connecting")q(Error("WebSocket connection failed"))},this.ws.onmessage=(D)=>{this.handleMessage(D.data)}})}disconnect(){if(this.ws)this.connectionState.set("disconnecting"),this.stopHeartbeat(),this.ws.close(1000,"Client disconnect"),this.ws=null,this.connectionState.set("disconnected")}scheduleReconnect(){this.reconnectAttempts++;let F=this.config.reconnectInterval*Math.min(this.reconnectAttempts,5);setTimeout(()=>{if(this.connectionState.get()==="disconnected")this.connect().catch(()=>{})},F)}startHeartbeat(){this.heartbeatTimer=setInterval(()=>{this.send({type:"ping"})},this.config.heartbeatInterval)}stopHeartbeat(){if(this.heartbeatTimer)clearInterval(this.heartbeatTimer),this.heartbeatTimer=null}flushMessageQueue(){while(this.messageQueue.length>0&&this.isConnected){let F=this.messageQueue.shift();if(F)this.send(F)}}send(F){if(this.ws?.readyState===WebSocket.OPEN)this.ws.send(JSON.stringify(F));else this.messageQueue.push(F)}sendWithResponse(F){return new Promise((q,D)=>{let G=`req_${++this.requestId}`;F.data={...F.data,_requestId:G},this.pendingRequests.set(G,{resolve:q,reject:D}),this.send(F),setTimeout(()=>{if(this.pendingRequests.has(G))this.pendingRequests.delete(G),D(Error("Request timeout"))},30000)})}handleMessage(F){try{let q=JSON.parse(F),D=A(q);if(!D){console.debug("[GoSPA] Received invalid WebSocket message, ignoring:",q);return}if(D.type==="pong")return;if(D.type==="init"&&D.sessionToken&&D.clientId)this.sessionData={token:D.sessionToken,clientId:D.clientId},M(this.sessionData);if(D.data?._responseId){let G=D.data._responseId,H=this.pendingRequests.get(G);if(H)if(this.pendingRequests.delete(G),D.type==="error"){let L=D.error?D.error.replace(/[<>\"']/g,""):"Unknown error";H.reject(Error(L))}else H.resolve(D.data)}this.config.onMessage(D)}catch(q){console.error("Failed to parse WebSocket message:",q)}}requestSync(){this.send({type:"sync"})}sendAction(F,q={}){this.send({type:"action",action:F,payload:q})}requestState(F){return this.sendWithResponse({type:"init",componentId:F})}}function x(F,q={}){if(J)J.sendAction(F,q);else console.warn("[GoSPA] Cannot send action: WebSocket not initialized")}var J=null;function Q(){return J}function W(F){if(J)J.disconnect();return J=new z(F),J}function b(F,q){let D=new U(F),G=q.ws||J,H=!1,L=D.set.bind(D);return D.set=(T)=>{if(H){L(T);return}let X=D.get();if(L(T),G?.isConnected)try{let P=()=>{G.send({type:"update",payload:{key:q.key,value:T}})};if(q.debounce)setTimeout(P,q.debounce);else P()}catch(P){console.warn("[GoSPA] Optimistic update failed, rolling back.",P),H=!0,L(X),H=!1}else console.warn("[GoSPA] WS disconnected, optimistic update rolled back."),H=!0,L(X),H=!1},D}function N(F,q,D){let G=D||J;if(!G?.isConnected)return;for(let[H,L]of Object.entries(q))G.send({type:"update",payload:{key:H,value:L.get()}})}function Y(F,q){Z(()=>{for(let[D,G]of Object.entries(q)){let H=F[D];if(H)H.set(G)}})}export{b as syncedRune,N as syncBatch,x as sendAction,W as initWebSocket,Q as getWebSocketClient,Y as applyStateUpdate,z as WSClient};
export{z as y,x as z,Q as A,W as B,b as C,Y as D};
