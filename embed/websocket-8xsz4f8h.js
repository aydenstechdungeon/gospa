import{X,Y as T}from"./runtime-1av6apsb.js";import"./runtime-nmjc1qqb.js";function A(D){if(!D||typeof D!=="object"||Array.isArray(D))return null;let q=D;if(typeof q.type!=="string")return null;let z={type:q.type};if(typeof q.componentId==="string")z.componentId=q.componentId;if(typeof q.action==="string")z.action=q.action;if(typeof q.key==="string")z.key=q.key;if(q.value!==void 0)z.value=q.value;if(typeof q.success==="boolean")z.success=q.success;if(q.data&&typeof q.data==="object"&&!Array.isArray(q.data))z.data=q.data;if(q.payload&&typeof q.payload==="object"&&!Array.isArray(q.payload))z.payload=q.payload;if(q.state&&typeof q.state==="object"&&!Array.isArray(q.state))z.state=q.state;if(q.diff&&typeof q.diff==="object"&&!Array.isArray(q.diff))z.diff=q.diff;if(q.patch&&typeof q.patch==="object"&&!Array.isArray(q.patch))z.patch=q.patch;if(typeof q.compressed==="boolean")z.compressed=q.compressed;if(typeof q.error==="string")z.error=q.error;if(typeof q.timestamp==="number")z.timestamp=q.timestamp;if(typeof q.sessionToken==="string")z.sessionToken=q.sessionToken;if(typeof q.clientId==="string")z.clientId=q.clientId;return z}var Z="gospa_session";function B(){try{let D=sessionStorage.getItem(Z);if(D)return JSON.parse(D)}catch(D){console.warn("[GoSPA] Failed to load session:",D)}return null}function M(D){try{sessionStorage.setItem(Z,JSON.stringify(D))}catch(q){console.warn("[GoSPA] Failed to save session:",q)}}class ${ws=null;config;reconnectAttempts=0;heartbeatTimer=null;messageQueue=[];connectionState;pendingRequests=new Map;requestId=0;sessionData=null;constructor(D){this.config={reconnect:!0,reconnectInterval:1000,maxReconnectAttempts:10,heartbeatInterval:30000,onOpen:()=>{},onClose:()=>{},onError:()=>{},onConnectionFailed:()=>{},onMessage:()=>{},...D},this.connectionState=new T("disconnected"),this.sessionData=B();try{let q=sessionStorage.getItem("gospa_ws_queue");if(q)this.messageQueue=JSON.parse(q)||[],sessionStorage.removeItem("gospa_ws_queue")}catch(q){console.warn("[GoSPA] Failed to restore message queue:",q)}window.addEventListener("beforeunload",()=>{if(this.messageQueue.length>0)try{sessionStorage.setItem("gospa_ws_queue",JSON.stringify(this.messageQueue))}catch(q){console.warn("[GoSPA] Failed to persist message queue:",q)}})}get state(){return this.connectionState.get()}get isConnected(){return this.connectionState.get()==="connected"}connect(){return new Promise((D,q)=>{if(this.ws?.readyState===WebSocket.OPEN){D();return}this.connectionState.set("connecting");try{this.ws=new WebSocket(this.config.url)}catch(z){this.connectionState.set("disconnected"),q(z);return}this.ws.onopen=()=>{if(this.connectionState.set("connected"),this.reconnectAttempts=0,this.startHeartbeat(),this.sessionData?.token)this.send({type:"init",sessionToken:this.sessionData.token,clientId:this.sessionData.clientId});this.flushMessageQueue(),this.send({type:"sync"}),this.config.onOpen(),D()},this.ws.onclose=(z)=>{if(this.connectionState.set("disconnected"),this.stopHeartbeat(),this.config.onClose(z),this.config.reconnect&&this.reconnectAttempts<this.config.maxReconnectAttempts)this.scheduleReconnect();else this.config.onConnectionFailed(Error("Max reconnect attempts reached"))},this.ws.onerror=(z)=>{if(this.config.onError(z),this.connectionState.get()==="connecting")q(Error("WebSocket connection failed"))},this.ws.onmessage=(z)=>{this.handleMessage(z.data)}})}disconnect(){if(this.ws)this.connectionState.set("disconnecting"),this.stopHeartbeat(),this.ws.close(1000,"Client disconnect"),this.ws=null,this.connectionState.set("disconnected")}scheduleReconnect(){this.reconnectAttempts++;let D=this.config.reconnectInterval*Math.min(this.reconnectAttempts,5);setTimeout(()=>{if(this.connectionState.get()==="disconnected")this.connect().catch(()=>{})},D)}startHeartbeat(){this.heartbeatTimer=setInterval(()=>{this.send({type:"ping"})},this.config.heartbeatInterval)}stopHeartbeat(){if(this.heartbeatTimer)clearInterval(this.heartbeatTimer),this.heartbeatTimer=null}flushMessageQueue(){while(this.messageQueue.length>0&&this.isConnected){let D=this.messageQueue.shift();if(D)this.send(D)}}send(D){if(this.ws?.readyState===WebSocket.OPEN)this.ws.send(JSON.stringify(D));else this.messageQueue.push(D)}sendWithResponse(D){return new Promise((q,z)=>{let F=`req_${++this.requestId}`;D.data={...D.data,_requestId:F},this.pendingRequests.set(F,{resolve:q,reject:z}),this.send(D),setTimeout(()=>{if(this.pendingRequests.has(F))this.pendingRequests.delete(F),z(Error("Request timeout"))},30000)})}handleMessage(D){try{let q=JSON.parse(D),z=A(q);if(!z){console.debug("[GoSPA] Received invalid WebSocket message, ignoring:",q);return}if(z.type==="pong")return;if(z.type==="init"&&z.sessionToken&&z.clientId)this.sessionData={token:z.sessionToken,clientId:z.clientId},M(this.sessionData);if(z.data?._responseId){let F=z.data._responseId,G=this.pendingRequests.get(F);if(G)if(this.pendingRequests.delete(F),z.type==="error")G.reject(Error(z.error||"Unknown error"));else G.resolve(z.data)}this.config.onMessage(z)}catch(q){console.error("Failed to parse WebSocket message:",q)}}requestSync(){this.send({type:"sync"})}sendAction(D,q={}){this.send({type:"action",action:D,payload:q})}requestState(D){return this.sendWithResponse({type:"init",componentId:D})}}function x(D,q={}){if(H)H.sendAction(D,q);else console.warn("[GoSPA] Cannot send action: WebSocket not initialized")}var H=null;function Q(){return H}function W(D){if(H)H.disconnect();return H=new $(D),H}function b(D,q){let z=new T(D),F=q.ws||H,G=!1,J=z.set.bind(z);return z.set=(P)=>{if(G){J(P);return}let U=z.get();if(J(P),F?.isConnected)try{let L=()=>{F.send({type:"update",payload:{key:q.key,value:P}})};if(q.debounce)setTimeout(L,q.debounce);else L()}catch(L){console.warn("[GoSPA] Optimistic update failed, rolling back.",L),G=!0,J(U),G=!1}else console.warn("[GoSPA] WS disconnected, optimistic update rolled back."),G=!0,J(U),G=!1},z}function N(D,q,z){let F=z||H;if(!F?.isConnected)return;for(let[G,J]of Object.entries(q))F.send({type:"update",payload:{key:G,value:J.get()}})}function Y(D,q){X(()=>{for(let[z,F]of Object.entries(q)){let G=D[z];if(G)G.set(F)}})}export{b as syncedRune,N as syncBatch,x as sendAction,W as initWebSocket,Q as getWebSocketClient,Y as applyStateUpdate,$ as WSClient};
export{$ as u,x as v,Q as w,W as x,b as y,Y as z};
